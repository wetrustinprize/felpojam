name: Dispatch Build & Zip

on:
  workflow_dispatch:

env:
  GODOT_VERSION: 4.5.1
  GAME_NAME: "So falta o Carimbo"

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: barichello/godot-ci:4.5.1

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Prepare export templates
        run: |
          mkdir -p ~/.local/share/godot/templates
          mv /root/.local/share/godot/templates/4.5.1.stable ~/.local/share/godot/templates/

      - name: Create directory scaffolding
        run: |
          mkdir -p dist/source
          mkdir -p dist/compiled/linux
          mkdir -p dist/compiled/windows
          mkdir -p dist/disclaimer

      - name: Copy source
        run: |
          rsync -av --exclude=dist --exclude=.git ./ dist/source/

      - name: Build Linux export
        run: |
          godot -v --export "Linux" dist/compiled/linux/${GAME_NAME}.x86_64

      - name: Build Windows export
        run: |
          godot -v --export "Windows" dist/compiled/windows/${GAME_NAME}.exe

      - name: Copy licenses and README
        run: |
          cp -r licenses/* dist/disclaimer/
          cp README.md dist/disclaimer/README.md
          cp README.md dist/README.md

      - name: Create ZIP archive
        run: |
          cd dist
          zip -r ../so_falta_o_carimbo.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: So falta o Carimbo
          path: so_falta_o_carimbo.zip
